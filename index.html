<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ø´Ø¹Ø¨Ø© 306</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color:#2c3e50; --secondary-color:#3498db; --accent-color:#1abc9c; --danger-color:#e74c3c; --success-color:#27ae60; --light-color:#ecf0f1; }
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Tajawal',sans-serif;}
        body{background:linear-gradient(135deg,var(--primary-color) 0%,var(--secondary-color) 100%);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px;}
        .container{width:100%;max-width:400px;}
        .logo-container{text-align:center;margin-bottom:30px;}
        .logo-container i{font-size:4rem;color:var(--accent-color);margin-bottom:15px;}
        .logo-container h1{color:white;font-size:2rem;margin-bottom:5px;}
        .logo-container p{color:rgba(255,255,255,0.8);font-size:1.1rem;}
        .auth-card{background-color:white;border-radius:15px;padding:30px;box-shadow:0 15px 30px rgba(0,0,0,0.2);transition:transform 0.3s ease;}
        .auth-card:hover{transform:translateY(-5px);}
        .auth-tabs{display:flex;margin-bottom:25px;border-bottom:2px solid #eee;}
        .auth-tab{flex:1;text-align:center;padding:12px;background:none;border:none;font-size:1.1rem;font-weight:500;color:#666;cursor:pointer;position:relative;transition:all 0.3s ease;}
        .auth-tab.active{color:var(--secondary-color);}
        .auth-tab.active::after{content:'';position:absolute;bottom:-2px;left:0;width:100%;height:3px;background-color:var(--secondary-color);border-radius:3px;}
        .auth-form{display:none;}
        .auth-form.active{display:block;}
        .form-group{margin-bottom:20px;}
        .form-group label{display:block;margin-bottom:8px;color:var(--primary-color);font-weight:500;}
        .form-control{width:100%;padding:12px 15px;border:2px solid #e0e0e0;border-radius:8px;font-size:1rem;transition:all 0.3s ease;}
        .form-control:focus{outline:none;border-color:var(--secondary-color);box-shadow:0 0 0 3px rgba(52,152,219,0.2);}
        .input-with-icon{position:relative;}
        .input-with-icon i{position:absolute;left:15px;top:50%;transform:translateY(-50%);color:#777;}
        .input-with-icon .form-control{padding-right:15px;padding-left:45px;}
        .btn{width:100%;padding:14px;border:none;border-radius:8px;font-size:1.1rem;font-weight:500;cursor:pointer;display:flex;justify-content:center;align-items:center;gap:10px;}
        .btn-primary{background-color:var(--secondary-color);color:white;}
        .btn-primary:hover{background-color:#2980b9;}
        .btn-success{background-color:var(--success-color);color:white;}
        .btn-success:hover{background-color:#219653;}
        .message{padding:12px;border-radius:8px;margin-top:15px;text-align:center;font-weight:500;display:none;}
        .message.error{background-color:rgba(231,76,60,0.1);color:var(--danger-color);border:1px solid rgba(231,76,60,0.2);}
        .message.success{background-color:rgba(39,174,96,0.1);color:var(--success-color);border:1px solid rgba(39,174,96,0.2);}
        .forgot-link{text-align:center;margin-top:20px;}
        .forgot-link a{color:var(--secondary-color);text-decoration:none;font-size:0.9rem;}
        .forgot-link a:hover{text-decoration:underline;}
        .vs-code-info {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 0.9rem;
        }
        @media (max-width:480px){.auth-card{padding:20px;}.logo-container h1{font-size:1.6rem;}.logo-container i{font-size:3rem;}}
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <i class="fas fa-graduation-cap"></i>
            <h1>Ø´Ø¹Ø¨Ø© <span style="color: #1abc9c;">306</span></h1>
            <p>Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</p>
        </div>

        <div class="auth-card">
   
            
            <div class="auth-tabs">
                <button class="auth-tab active" data-form="login-form">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                <button class="auth-tab" data-form="register-form">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
            </div>

            <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
            <form id="login-form" class="auth-form active">
                <div class="form-group">
                    <label for="login-email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <div class="input-with-icon">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="login-email" class="form-control" placeholder="student306@example.com">
                    </div>
                </div>

                <div class="form-group">
                    <label for="login-password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <div class="input-with-icon">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="login-password" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" id="login-btn">
                    <i class="fas fa-sign-in-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                </button>

                <div class="forgot-link">
                    <a href="#" id="forgot-password">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</a>
                </div>
            </form>

            <!-- ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ -->
            <form id="register-form" class="auth-form">
                <div class="form-group">
                    <label for="register-name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ *</label>
                    <div class="input-with-icon">
                        <i class="fas fa-user"></i>
                        <input type="text" id="register-name" class="form-control" 
                               placeholder="Ù…Ø­Ù…Ø¯" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="register-lastname">Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© (Ø§Ù„Ù„Ù‚Ø¨) *</label>
                    <div class="input-with-icon">
                        <i class="fas fa-user-tag"></i>
                        <input type="text" id="register-lastname" class="form-control" 
                               placeholder="Ø§Ù„Ø¹ØªÙŠØ¨ÙŠ" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="register-email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ *</label>
                    <div class="input-with-icon">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="register-email" class="form-control" 
                               placeholder="student306@example.com" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="register-password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *</label>
                    <div class="input-with-icon">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="register-password" class="form-control" 
                               placeholder="Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ©" required minlength="6">
                    </div>
                </div>

                <div class="form-group">
                    <label for="register-confirm-password">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *</label>
                    <div class="input-with-icon">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="register-confirm-password" class="form-control" 
                               placeholder="Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
                    </div>
                </div>

                <button type="submit" class="btn btn-success" id="register-btn">
                    <i class="fas fa-user-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
                </button>
            </form>

            <div id="message" class="message"></div>
        </div>
    </div>

    <!-- Firebase v12 Ø§Ù„ÙƒØ§Ù…Ù„ -->
<script type="module">
    // ===============================
    // Firebase v12 SDK
    // ===============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        signInWithEmailAndPassword, 
        createUserWithEmailAndPassword, 
        sendPasswordResetEmail,
        updateProfile 
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { 
        getDatabase, 
        ref, 
        set,
        get
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

    // ===============================
    // ØªÙƒÙˆÙŠÙ† Firebase
    // ===============================
    const firebaseConfig = {
        apiKey: "AIzaSyCYbDqGBlBEEDGNfXbAbsS4sZupNDb7jrY",
        authDomain: "system-306.firebaseapp.com",
        databaseURL: "https://system-306-default-rtdb.firebaseio.com",
        projectId: "system-306",
        storageBucket: "system-306.firebasestorage.app",
        messagingSenderId: "471316495588",
        appId: "1:471316495588:web:4d7ba9be7fea17c7a8c0f1",
        measurementId: "G-T4RTTBWHKL"
    };

    // ===============================
    // ØªÙ‡ÙŠØ¦Ø© Firebase
    // ===============================
    let app, auth, database;
    
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        database = getDatabase(app);
        console.log("âœ… Firebase ØªÙ… Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­");
    } catch (error) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:", error);
        if (document.querySelector('.vs-code-info')) {
            document.querySelector('.vs-code-info').innerHTML = 
                '<i class="fas fa-exclamation-triangle"></i> <strong>Firebase ØºÙŠØ± Ù…ØªØµÙ„</strong><br>' +
                'ØªØ­Ù‚Ù‚ Ù…Ù†: 1. Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª 2. ØªÙƒÙˆÙŠÙ† Firebase';
        }
    }

    // ===============================
    // Ù…ØªØºÙŠØ±Ø§Øª DOM
    // ===============================
    const messageDiv = document.getElementById("message");

    // ===============================
    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    // ===============================
    function showMessage(text, type = "error") {
        if (!messageDiv) return;
        
        messageDiv.innerHTML = text;
        messageDiv.className = `message ${type}`;
        messageDiv.style.display = "block";
        
        setTimeout(() => {
            messageDiv.style.display = "none";
        }, 5000);
    }

    // ===============================
    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª
    // ===============================
    async function checkRegistrationStatus() {
        try {
            if (!database) {
                console.error("âŒ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ØªØ§Ø­Ø©");
                return true; // Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
            }
            
            const statusRef = ref(database, 'system/registrationEnabled');
            const snapshot = await get(statusRef);
            
            if (snapshot.exists()) {
                const isEnabled = snapshot.val();
                console.log(`ğŸ“‹ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª: ${isEnabled ? 'Ù…ÙØ¹Ù„Ø©' : 'Ù…Ø¹Ø·Ù„Ø©'}`);
                
                // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù…Ø¹Ø·Ù„Ø©
                const registerTab = document.querySelector('.auth-tab[data-form="register-form"]');
                const registerForm = document.getElementById('register-form');
                
                if (registerTab && !isEnabled) {
                    registerTab.style.display = 'none';
                    if (registerForm.classList.contains('active')) {
                        document.querySelector('.auth-tab[data-form="login-form"]').click();
                    }
                    showMessage("âš ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…ØªÙˆÙ‚Ù Ø­Ø§Ù„ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±", "warning");
                } else if (registerTab && isEnabled) {
                    registerTab.style.display = 'flex';
                }
                
                return isEnabled;
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªØŒ Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§ Ù…Ø¹ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                await set(statusRef, true);
                console.log("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©");
                return true;
            }
        } catch (error) {
            console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª:", error);
            return true; // Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        }
    }

    // ===============================
    // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
    // ===============================
    document.querySelectorAll(".auth-tab").forEach(tab => {
        tab.addEventListener("click", () => {
            document.querySelectorAll(".auth-tab").forEach(t => t.classList.remove("active"));
            document.querySelectorAll(".auth-form").forEach(f => f.classList.remove("active"));
            
            tab.classList.add("active");
            const formId = tab.getAttribute("data-form");
            document.getElementById(formId).classList.add("active");
            
            if (messageDiv) {
                messageDiv.style.display = "none";
            }
        });
    });

    // ===============================
    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    // ===============================
    document.getElementById("login-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const email = document.getElementById("login-email").value.trim();
        const password = document.getElementById("login-password").value;
        const loginBtn = document.getElementById("login-btn");

        if (!email || !password) {
            showMessage("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„", "error");
            return;
        }

        if (!auth) {
            showMessage("Firebase ØºÙŠØ± Ù…ØªØµÙ„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª", "error");
            return;
        }

        try {
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';

            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¯ÙŠØ±Ø§Ù‹
            const isAdmin = email === "hussainasari0@gmail.com";
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·
            await logUserActivity(userCredential.user.uid, 'login');
            
            // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const userData = {
                uid: userCredential.user.uid,
                email: userCredential.user.email,
                displayName: userCredential.user.displayName,
                isAdmin: isAdmin
            };
            
            localStorage.setItem('currentUser', JSON.stringify(userData));
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¯ÙŠØ±Ø§Ù‹ØŒ ØªÙˆØ¬Ù‡Ù‡ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
            if (isAdmin) {
                showMessage(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!<br>Ù…Ø±Ø­Ø¨Ø§Ù‹ ${userCredential.user.displayName || email}`, "success");
                
                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ±
                setTimeout(() => {
                    window.location.href = "admin-panel.html";
                }, 1500);
            } else {
                showMessage(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!<br>Ù…Ø±Ø­Ø¨Ø§Ù‹ ${userCredential.user.displayName || email}`, "success");
                
                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ±
                setTimeout(() => {
                    window.location.href = "main.html";
                }, 1500);
            }

        } catch (error) {
            console.error("âŒ Ø®Ø·Ø£ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:", error.code, error.message);
            
            let errorMessage = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
            
            switch(error.code) {
                case 'auth/invalid-email':
                    errorMessage = "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­";
                    break;
                case 'auth/user-not-found':
                    errorMessage = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ";
                    break;
                case 'auth/wrong-password':
                    errorMessage = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
                    break;
                case 'auth/too-many-requests':
                    errorMessage = "Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹";
                    break;
                case 'auth/user-disabled':
                    errorMessage = "Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ ØªÙ… ØªØ¹Ø·ÙŠÙ„Ù‡";
                    break;
                case 'auth/network-request-failed':
                    errorMessage = "ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…";
                    break;
            }
            
            showMessage(errorMessage, "error");
            loginBtn.disabled = false;
            loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        }
    });

    // ===============================
    // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª
    // ===============================
    document.getElementById("register-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const firstName = document.getElementById("register-name").value.trim();
        const lastName = document.getElementById("register-lastname").value.trim();
        const email = document.getElementById("register-email").value.trim();
        const password = document.getElementById("register-password").value;
        const confirmPassword = document.getElementById("register-confirm-password").value;
        const registerBtn = document.getElementById("register-btn");

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!firstName || !lastName || !email || !password || !confirmPassword) {
            showMessage("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„", "error");
            return;
        }

        if (password.length < 6) {
            showMessage("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„", "error");
            return;
        }

        if (password !== confirmPassword) {
            showMessage("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚Ø©", "error");
            return;
        }

        if (!auth) {
            showMessage("Firebase ØºÙŠØ± Ù…ØªØµÙ„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª", "error");
            return;
        }

        try {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
            const canRegister = await checkRegistrationStatus();
            if (!canRegister) {
                showMessage("âš ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…ØªÙˆÙ‚Ù Ø­Ø§Ù„ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±", "error");
                return;
            }

            registerBtn.disabled = true;
            registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...';

            // 1. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Authentication
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            // 2. ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ + Ø§Ù„Ù„Ù‚Ø¨)
            const fullName = `${firstName} ${lastName}`;
            await updateProfile(user, {
                displayName: fullName
            });

            // 3. Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Realtime Database
            const userData = {
                uid: user.uid,
                email: email,
                firstName: firstName,
                lastName: lastName,
                fullName: fullName,
                role: "student",
                class: "306",
                createdAt: new Date().toISOString()
            };

            const userRef = ref(database, `users/${user.uid}`);
            await set(userRef, userData);

            // 4. ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
            await logUserActivity(user.uid, 'register');

            showMessage(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!<br>Ù…Ø±Ø­Ø¨Ø§Ù‹ ${fullName}`, "success");

            // 5. Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ù„ÙŠØ§Ù‹
            localStorage.setItem('currentUser', JSON.stringify({
                uid: user.uid,
                email: email,
                displayName: fullName,
                firstName: firstName,
                lastName: lastName,
                isAdmin: false
            }));

            // 6. Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            setTimeout(() => {
                window.location.href = "main.html";
            }, 1500);

        } catch (error) {
            console.error("âŒ Ø®Ø·Ø£ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨:", error.code, error.message);
            
            let errorMessage = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨";
            
            switch(error.code) {
                case 'auth/email-already-in-use':
                    errorMessage = "Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„";
                    break;
                case 'auth/invalid-email':
                    errorMessage = "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­";
                    break;
                case 'auth/weak-password':
                    errorMessage = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©ØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£Ù‚ÙˆÙ‰";
                    break;
                case 'auth/operation-not-allowed':
                    errorMessage = "Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø­Ø§Ù„ÙŠØ§Ù‹";
                    break;
                case 'auth/network-request-failed':
                    errorMessage = "ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…";
                    break;
            }
            
            showMessage(errorMessage, "error");
            registerBtn.disabled = false;
            registerBtn.innerHTML = '<i class="fas fa-user-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
        }
    });

    // ===============================
    // Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    // ===============================
    document.getElementById("forgot-password").addEventListener("click", async (e) => {
        e.preventDefault();
        
        const email = prompt("Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:");
        if (!email) return;

        if (!auth) {
            alert("Firebase ØºÙŠØ± Ù…ØªØµÙ„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");
            return;
        }

        try {
            await sendPasswordResetEmail(auth, email);
            alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.\nÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.");
        } catch (error) {
            let errorMessage = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©";
            
            if (error.code === 'auth/user-not-found') {
                errorMessage = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ";
            } else if (error.code === 'auth/invalid-email') {
                errorMessage = "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­";
            }
            
            alert(errorMessage);
        }
    });

    // ===============================
    // ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    // ===============================
    async function logUserActivity(userId, activityType) {
        if (!database) return;
        
        try {
            const activityRef = ref(database, `userActivities/${userId}/${Date.now()}`);
            await set(activityRef, {
                type: activityType,
                timestamp: new Date().toISOString()
            });
        } catch (error) {
            console.warn("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·:", error);
        }
    }

    // ===============================
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    // ===============================
    if (auth) {
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„:", user.email);
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„Ø§Ù‹ØŒ ØªÙˆØ¬ÙŠÙ‡Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©
                if (window.location.pathname.endsWith('login.html')) {
                    showMessage(`ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ ${user.displayName || user.email}!`, "success");
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¯ÙŠØ±Ø§Ù‹
                    const isAdmin = user.email === "hussainasari0@gmail.com";
                    
                    // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ù…Ø­Ù„ÙŠØ§Ù‹
                    localStorage.setItem('currentUser', JSON.stringify({
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                        isAdmin: isAdmin
                    }));
                    
                    setTimeout(() => {
                        if (isAdmin) {
                            window.location.href = "admin-panel.html";
                        } else {
                            window.location.href = "main.html";
                        }
                    }, 1000);
                }
            }
        });
    }

    // ===============================
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    // ===============================
    async function initializeSystemSettings() {
        try {
            if (!database) return;
            
            const systemRef = ref(database, 'system');
            const snapshot = await get(systemRef);
            
            if (!snapshot.exists()) {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                const defaultSettings = {
                    registrationEnabled: true,
                    registrationStatusUpdated: new Date().toISOString(),
                    createdBy: "system",
                    createdAt: new Date().toISOString()
                };
                
                await set(systemRef, defaultSettings);
                console.log("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©");
            }
        } catch (error) {
            console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…:", error);
        }
    }

    // ===============================
    // Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· Ù„Ù„Ù…Ø¯ÙŠØ±ÙŠÙ†
    // ===============================
    function addAdminLink() {
        const adminLink = document.createElement('div');
        adminLink.className = 'admin-access';
        adminLink.style.cssText = `
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        `;
        
        adminLink.innerHTML = `
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 10px;">Ù‡Ù„ Ø£Ù†Øª Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…ØŸ</p>
            <a href="admin-login.html" style="color: var(--accent-color); text-decoration: none; font-weight: 500;">
                <i class="fas fa-user-shield"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø¯ÙŠØ±
            </a>
        `;
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø¹Ø¯ Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        const loginForm = document.getElementById('login-form');
        if (loginForm) {
            loginForm.parentNode.insertBefore(adminLink, loginForm.nextSibling);
        }
    }

    // ===============================
    // Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
    // ===============================
    function setupTestData() {
        // Ø²Ø± Ù„Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
        const testBtn = document.createElement('button');
        testBtn.innerHTML = '<i class="fas fa-flask"></i> Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©';
        testBtn.style.cssText = `
            background: #9b59b6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            margin: 10px auto;
            display: block;
            cursor: pointer;
        `;
        
        testBtn.onclick = () => {
            document.getElementById('login-email').value = 'test@example.com';
            document.getElementById('login-password').value = '123456';
            document.getElementById('register-name').value = 'Ù…Ø­Ù…Ø¯';
            document.getElementById('register-lastname').value = 'Ø§Ù„Ø¹ØªÙŠØ¨ÙŠ';
            document.getElementById('register-email').value = `student${Date.now()}@section306.edu`;
            document.getElementById('register-password').value = '123456';
            document.getElementById('register-confirm-password').value = '123456';
            
            showMessage("ØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„", "info");
        };
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…ÙƒØ§Ù† Ù„Ø¹Ø±Ø¶Ù‡
        const vsCodeInfo = document.querySelector('.vs-code-info');
        if (vsCodeInfo) {
            vsCodeInfo.appendChild(testBtn);
        }
    }

    // ===============================
    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    // ===============================
    document.addEventListener('DOMContentLoaded', async () => {
        console.log("ğŸš€ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¬Ø§Ù‡Ø²Ø©");
        
        if (!auth) {
            showMessage("âš ï¸ Firebase ØºÙŠØ± Ù…ØªØµÙ„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØªÙƒÙˆÙŠÙ† Firebase", "warning");
            return;
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
        await initializeSystemSettings();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª
        await checkRegistrationStatus();
        
        // Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¯ÙŠØ±
        addAdminLink();
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
        setupTestData();
        
        console.log("âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø¬Ø§Ù‡Ø²Ø©");
    });

</script>
</body>
</html>