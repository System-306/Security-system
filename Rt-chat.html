<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ</title>
        <link rel="icon" type="image/x-icon" href="img//icon1.jpg">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');

    body {
      margin: 0;
      padding: 0;
      font-family: 'Tajawal', sans-serif;
      background-color: #212121;
      color: white;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #chatBox {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .message {
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 80%;
      word-wrap: break-word;
      font-size: 16px;
      width: fit-content;
    }

    .user {
      align-self: flex-start;
      color: white;
      border-bottom-right-radius: 0;
    }

    .bot {
      align-self:flex-end ;
      background-color: #333333;
      color: white;
      border-bottom-left-radius: 0;
    }

    #toolbar {
      display: flex;
      justify-content: space-between;
      padding: 10px 20px 0;
    }

    .action-button {
      padding: 8px 12px;
      font-size: 14px;
      background-color: #333333;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .action-button:hover {
      background-color: #6d6f80;
    }

    #inputArea {
      display: flex;
      padding: 10px;
      background-color: #333333;
      border-top: 1px solid #555;
    }

    #userInput {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      background-color: #333333;
      color: white;
      outline: none;
    }

    #sendButton {
      width: 50px;
      height: 50px;
      margin-right: 10px;
      background-color: #fff;
      border: none;
      border-radius: 50%;
      color: black;
      font-size: 16px;
      cursor: pointer;
    }

    /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„ØªØ£ÙƒÙŠØ¯ */
    .modal {
      display: none;
      position: fixed;
      z-index: 5;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: #fff;
      color: black;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      width: 90%;
      max-width: 400px;
    }

    .modal-content input {
      width: 90%;
      padding: 8px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .modal-content button {
      margin: 5px;
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }

    .nextBtn { background-color: #10a37f; color: white; }
    .cancelBtn { background-color: #6c757d; color: white; }
    .confirmBtn { background-color: #dc3545; color: white; }
  </style>
</head>
<body>

<!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠØ© -->
<div id="toolbar">
  <button class="action-button" id="trainButton">ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯</button>

  <button class="action-button" id="clearButton">Ù…Ø³Ø­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</button>
</div>

<!-- Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
<div id="chatBox"></div>

<!-- Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
<div id="inputArea">
  <input type="text" id="userInput" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ø³Ø§Ù„ØªÙƒ..." />
  <button id="sendButton">â¤</button>
</div>

<!-- Ù†Ø§ÙØ°Ø© ØªØ¯Ø±ÙŠØ¨ -->
<div class="modal" id="trainModal">
  <div class="modal-content">
    <p id="trainStep">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„:</p>
    <input type="text" id="trainInput" />
    <button class="nextBtn">Ø§Ù„ØªØ§Ù„ÙŠ</button>
    <button class="cancelBtn">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<!-- ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù -->
<div class="modal" id="confirmModal">
  <div class="modal-content">
    <p>Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŸ</p>
    <button class="confirmBtn">Ù†Ø¹Ù…</button>
    <button class="cancelBtn">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<script src="responses.js"></script>
<script src="main.js"></script>
<script>
  // Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø¯Ø±Ø¨Ø© Ù…Ù† localStorage
  let savedResponses = JSON.parse(localStorage.getItem("responses")) || {};

  // Ø¯Ù…Ø¬ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø¨Ø©
  let responses = { ...defaultResponses, ...savedResponses };

  // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
  if (localStorage.getItem("messages")) {
    document.getElementById("chatBox").innerHTML = localStorage.getItem("messages");
  }

  // ØªØ¨Ø³ÙŠØ· Ø§Ù„Ù†Øµ (Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©)
  function simplifyText(text) {
    return text.toLowerCase().replace(/[ØŸ.,!ØŒ]/g, "").trim();
  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ´Ø§Ø¨Ù‡ ÙƒÙ„Ù…Ø© Ø£Ùˆ Ù…Ø±Ø§Ø¯ÙØ§ØªÙ‡Ø§
  function matchesKey(input, key) {
    input = simplifyText(input);
    key = simplifyText(key);

    if (input.includes(key)) return true;

    if (synonyms[key]) {
      for (const syn of synonyms[key]) {
        if (input.includes(simplifyText(syn))) return true;
      }
    }
    return false;
  }

  // Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø±Ø¯ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ù…Ø±Ø§Ø¯ÙØ§Øª
  function getResponse(input) {
    const simplified = simplifyText(input);

    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙˆÙ‚Øª
    if (
      simplified.includes("Ø§Ù„ÙˆÙ‚Øª") || 
      simplified.includes("ÙƒÙ… Ø§Ù„Ø³Ø§Ø¹Ø©") || 
      simplified.includes("Ù…Ø§ Ø§Ù„ÙˆÙ‚Øª") ||
      simplified.includes("Ø§Ù„Ø³Ø§Ø¹Ø©")
    ) {
      const now = new Date();
      const timeString = now.toLocaleTimeString('ar-EG', { hour12: false });
      return `Ø§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ø¢Ù† Ù‡ÙŠ ${timeString}`;
    }

    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
    if (
      simplified.includes("Ø§Ù„ØªØ§Ø±ÙŠØ®") ||
      simplified.includes("Ù…Ø§ Ù‡Ùˆ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…") ||
      simplified.includes("ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…") ||
      simplified.includes("Ø§Ù„ÙŠÙˆÙ…")
    ) {
      const now = new Date();
      const dateString = now.toLocaleDateString('ar-EG', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      return `ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ù‡Ùˆ ${dateString}`;
    }

    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    for (const key in responses) {
      if (matchesKey(input, key)) {
        const reply = responses[key];
        if (Array.isArray(reply)) {
          return reply[Math.floor(Math.random() * reply.length)];
        }
        return reply;
      }
    }
    return "Ù„Ù… Ø£ÙÙ‡Ù… Ù‚ØµØ¯Ùƒ Ø¨Ø¹Ø¯. Ù‡Ù„ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ¶ÙŠØ­ Ø£ÙƒØ«Ø±ØŸ ğŸ¤”";
  }

  // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
  function addMessage(text, sender) {
    const box = document.getElementById("chatBox");
    const msg = document.createElement("div");
    msg.className = `message ${sender}`;
    msg.innerText = text;
    box.appendChild(msg);
    box.scrollTop = box.scrollHeight;
  }

  // Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
  function saveChat() {
    localStorage.setItem("messages", document.getElementById("chatBox").innerHTML);
  }

  // Ù†Ø·Ù‚ Ø§Ù„Ù†Øµ
  function speak(text) {
    if ("speechSynthesis" in window) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "ar-SA";
      speechSynthesis.cancel(); // Ù„Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ÙƒÙ„Ø§Ù… Ø³Ø§Ø¨Ù‚ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡
      speechSynthesis.speak(utterance);
    }
  }

  // Ø­Ø¯Ø« Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
  document.getElementById("sendButton").addEventListener("click", processUserInput);
  document.getElementById("userInput").addEventListener("keypress", function(e) {
    if (e.key === "Enter") processUserInput();
  });

  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
  function processUserInput() {
    const input = document.getElementById("userInput").value.trim();
    if (!input) return;

    addMessage(input, "user");
    document.getElementById("userInput").value = "";

    setTimeout(() => {
      const reply = getResponse(input);
      addMessage(reply, "bot");
      speak(reply);
      saveChat();
    }, 400);
  }

  // Ø§Ù„ØªØ¯Ø±ÙŠØ¨ - Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ­Ø§Ù„Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨
  let trainStep = 1;
  let newQ = "";

  // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨
  document.getElementById("trainButton").addEventListener("click", () => {
    trainStep = 1;
    newQ = "";
    document.getElementById("trainStep").innerText = "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„:";
    document.getElementById("trainInput").value = "";
    document.getElementById("trainModal").style.display = "flex";
  });

  // Ø²Ø± Ø§Ù„ØªØ§Ù„ÙŠ ÙÙŠ Ø§Ù„ØªØ¯Ø±ÙŠØ¨
  document.querySelector(".nextBtn").addEventListener("click", () => {
    const val = document.getElementById("trainInput").value.trim();
    if (!val) return;

    if (trainStep === 1) {
      newQ = val;
      document.getElementById("trainStep").innerText = "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ø¯:";
      document.getElementById("trainInput").value = "";
      trainStep = 2;
    } else {
      savedResponses[newQ] = val;
      localStorage.setItem("responses", JSON.stringify(savedResponses));
      responses = { ...defaultResponses, ...savedResponses };

      document.getElementById("trainModal").style.display = "none";
      alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø¯ ğŸ‘");
    }
  });

  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
  document.querySelectorAll(".cancelBtn").forEach(btn =>
    btn.addEventListener("click", () => {
      document.getElementById("trainModal").style.display = "none";
      document.getElementById("confirmModal").style.display = "none";
    })
  );

  // ØªØ£ÙƒÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
  document.getElementById("clearButton").addEventListener("click", () => {
    document.getElementById("confirmModal").style.display = "flex";
  });

  document.querySelector(".confirmBtn").addEventListener("click", () => {
    localStorage.removeItem("messages");
    document.getElementById("chatBox").innerHTML = "";
    document.getElementById("confirmModal").style.display = "none";
  });

  // Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
  window.addEventListener("load", () => {
    if (!localStorage.getItem("messages")) {
      addMessage("Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ! ğŸ‘‹ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ", "bot");
    }
  });
</script>

</body>
</html>